-- Old Roll Call Table
CREATE TABLE O_RollCall (
    Roll_No INT PRIMARY KEY,
    Name VARCHAR(30),
    Attendance VARCHAR(10)
);

-- New Roll Call Table
CREATE TABLE N_RollCall (
    Roll_No INT PRIMARY KEY,
    Name VARCHAR(30),
    Attendance VARCHAR(10)
);

-- Insert sample data
INSERT INTO O_RollCall VALUES (1, 'Ravi', 'Present');
INSERT INTO O_RollCall VALUES (2, 'Soham', 'Absent');
INSERT INTO O_RollCall VALUES (3, 'Mohan', 'Present');

INSERT INTO N_RollCall VALUES (2, 'Soham', 'Absent');  -- duplicate
INSERT INTO N_RollCall VALUES (3, 'Mohan', 'Present'); -- duplicate
INSERT INTO N_RollCall VALUES (4, 'Omkar', 'Present'); -- new
INSERT INTO N_RollCall VALUES (5, 'Raj', 'Absent');    -- new

-- ✅ PARAMETERIZED CURSOR PROGRAM
DO $$
DECLARE
    -- Parameterized cursor that takes Roll_No as input
    CURSOR cur_roll(p_roll INT) IS
        SELECT Roll_No, Name, Attendance 
        FROM N_RollCall 
        WHERE Roll_No = p_roll;

    v_roll INT;
    v_name VARCHAR(30);
    v_att  VARCHAR(10);
    v_exists INT;
BEGIN
    -- Loop through each record in N_RollCall
    FOR rec IN SELECT * FROM N_RollCall LOOP
        -- Check if Roll_No already exists in O_RollCall
        SELECT COUNT(*) INTO v_exists 
        FROM O_RollCall 
        WHERE Roll_No = rec.Roll_No;

        IF v_exists = 0 THEN
            -- Open parameterized cursor for this Roll_No
            OPEN cur_roll(rec.Roll_No);
            FETCH cur_roll INTO v_roll, v_name, v_att;

            -- Insert into old table if not present
            INSERT INTO O_RollCall VALUES (v_roll, v_name, v_att);
            RAISE NOTICE 'Inserted Roll No: %, Name: %', v_roll, v_name;

            CLOSE cur_roll;
        ELSE
            RAISE NOTICE 'Skipped Roll No: % (Already Exists)', rec.Roll_No;
        END IF;
    END LOOP;
END
$$;

-- ✅ View final merged table
SELECT * FROM O_RollCall;
