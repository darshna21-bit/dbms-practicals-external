CREATE DATABASE library;
\c library

CREATE TABLE Borrower(
Rollno INT,
Name VARCHAR(20),
DateofIssue DATE,
NameofBook VARCHAR(30),
Status CHAR(1)
);

INSERT INTO Borrower VALUES
(14,'Ram','2022-09-19','Operating System','I'),
(27,'Soham','2022-07-24','Object Oriented Programming','I'),
(34,'Mohan','2022-06-12','Microprocessor','I'),
(48,'Om','2022-04-19','Mechanics','I');

CREATE TABLE Fine(
Rollno INT,
Date DATE,
Amount INT
);

DECLARE
r INT := 14;
b VARCHAR(30) := 'Operating System';
doi DATE;
diff INT;
fine_amt INT := 0;
no_record INT;
BEGIN
SELECT COUNT(*) INTO no_record
FROM Borrower
WHERE Rollno = r AND NameofBook = b;

IF no_record = 0 THEN
    RAISE_APPLICATION_ERROR(-20001, 'Book not found for given Roll number!');
ELSE
    SELECT DateofIssue INTO doi
    FROM Borrower
    WHERE Rollno = r AND NameofBook = b;

    diff := CURRENT_DATE - doi;

    IF diff BETWEEN 15 AND 30 THEN
        fine_amt := diff * 5;
    ELSIF diff > 30 THEN
        fine_amt := diff * 50;
    ELSE
        fine_amt := 0;
    END IF;

    IF fine_amt > 0 THEN
        INSERT INTO Fine VALUES (r, CURRENT_DATE, fine_amt);
    END IF;

    UPDATE Borrower
    SET Status = 'R'
    WHERE Rollno = r AND NameofBook = b;

    DBMS_OUTPUT.PUT_LINE('Fine for Roll No ' || r || ' is Rs. ' || fine_amt);
    DBMS_OUTPUT.PUT_LINE('Book Status Updated to Returned (R)');
END IF;

EXCEPTION
WHEN OTHERS THEN
DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/
SELECT * FROM Fine;
SELECT * FROM Borrower;
