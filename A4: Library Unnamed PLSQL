Drop Table If Exists fine;
Drop Table If Exists borrower;

Create Table borrower (
    roll_no      Int,
    name         Varchar(50),
    dateofissue  Date,
    nameofbook   Varchar(100),
    status       Char(1)  -- 'I' = Issued, 'R' = Returned
);

Create Table fine (
    roll_no   Int,
    finedate  Date,
    amt       Numeric(10)
);

Insert Into borrower Values
(1, 'Ravi',  Current_Date - Interval '20 days', 'DBMS Book', 'I'),
(2, 'Sneha', Current_Date - Interval '40 days', 'Java Book', 'I'),
(3, 'Amit',  Current_Date - Interval '10 days', 'SQL Book', 'I');

Do $$
Declare
    v_rollno      Int := 1;            -- you can change to test
    v_book        Text := 'DBMS Book'; -- you can change to test
    v_dateofissue Date;
    v_days        Int;
    v_fine        Numeric := 0;
Begin
    -- Try to fetch the issue date
    Begin
        Select dateofissue Into v_dateofissue
        From borrower
        Where roll_no = v_rollno
          And nameofbook = v_book
          And status = 'I';
    Exception
        When no_data_found Then
            Raise Notice 'Error: No record found for given Roll_no and Book.';
            Return;
    End;

    -- Calculate days
    v_days := (Current_Date - v_dateofissue);

    -- Fine logic
    If v_days > 30 Then
        v_fine := v_days * 50;
    Elsif v_days >= 15 Then
        v_fine := v_days * 5;
    Else
        v_fine := 0;
    End If;

    Update borrower
    Set status = 'R'
    Where roll_no = v_rollno
      And nameofbook = v_book;

    If v_fine > 0 Then
        Insert Into fine Values (v_rollno, Current_Date, v_fine);
    End If;

    Raise Notice 'Book returned successfully.';
    Raise Notice 'Days kept: %', v_days;
    Raise Notice 'Fine: Rs %', v_fine;

Exception
    When Others Then
        Raise Notice 'Unexpected error occurred: %', Sqlerrm;
End $$;

Select * From borrower;
Select * From fine;
